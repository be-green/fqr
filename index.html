<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fast Quantile Regression • fqr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Fast Quantile Regression">
<meta property="og:description" content="The fqr package uses accelerated gradient descent combined with a huber-style approximation of the quantile loss function to perform linear quantile regression at scale.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">fqr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<div id="fqr-fast-approximate-quantile-regression" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#fqr-fast-approximate-quantile-regression" class="anchor"></a>fqr: Fast (Approximate) Quantile Regression</h1></div>
<!-- badges: start -->

<p>The <code>fqr</code> package makes quantile regression fast and scaleable using accelerated gradient descent. This project began as an attempt at a smoothed version of the quantile objective function based on <a href="https://link.springer.com/article/10.1007/s10107-004-0552-5">Nesterov’s 2005 paper</a> for use in the <a href="https://github.com/be-green">quantspace package</a> for problems too large for interior point methods to handle. The <a href="https://github.com/XiaoouPan/conquer">conquer package</a> has an efficient approach to gradient descent and a very useful step-size selection approach, and the relevant code in this package is largely drawn from their implementation in the <a href="https://github.com/XiaoouPan/conquer">package</a> and <a href="https://doi.org/10.1016/j.jeconom.2021.07.010">paper</a>.</p>
<p><code>fqr</code>can handle quantile regression problems on the order of 10 million rows and 100 columns in less than a minute, and can exactly match existing implementations on small problems.</p>
<p>While the quantile loss function isn’t differentiable, you can get an arbitrarily close smooth approximation by replacing the “check” function with an appropriately tilted least squares approximation for a small neighborhood around the origin. As the size of that window goes to zero, you have your check function back!</p>
<p>The package uses 2 stopping rules to assess convergence: the maximum value of the gradient vector (for the coefficients of the quantile regression) and the relative change in the loss function (scaled by the step size).</p>
<p><code>fqr</code> is substantially faster than the <code>quantreg</code> package’s simplex and interior point methods (e.g. “br” or “pfn”), especially for large problems, and is comparable to the <code>conquer</code> package, though it tends to be slightly slower due to the default accuracy tolerance settings and some overhead from additional convergence checks. The algorithm implemented via the Armadillo library for linear algebra in C++. It also has no dependencies other than base R and (if building from source) a C++ compiler.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>You can install the fqr package from github by running</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get remotes if needed:</span>
<span class="co"># install.packages("remotes")</span>

<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"be-green/fqr"</span><span class="op">)</span></code></pre></div>
</div>
<div id="basic-use" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-use" class="anchor"></a>Basic Use</h2>
<p>The <code>fqr</code> package uses the same basic formula interface that <code>lm</code> does, with standard errors calculated based on subsampling.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://brice.green/fqr">fqr</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">rock</span><span class="op">)</span>

<span class="fu"><a href="reference/fit_fqr.html">fqr</a></span><span class="op">(</span><span class="va">area</span> <span class="op">~</span> <span class="va">peri</span>, data <span class="op">=</span> <span class="va">rock</span>, tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Tau:  0.25 </span>
<span class="co">#&gt;              Coefficient           SE</span>
<span class="co">#&gt; (Intercept) 5.213347e+03 500.04947110</span>
<span class="co">#&gt; peri        4.185437e-02   0.01041795</span>
<span class="co">#&gt; Tau:  0.5 </span>
<span class="co">#&gt;              Coefficient           SE</span>
<span class="co">#&gt; (Intercept) 7348.5642814 4.255263e+02</span>
<span class="co">#&gt; peri           0.0494302 7.136446e-03</span>
<span class="co">#&gt; Tau:  0.75 </span>
<span class="co">#&gt;              Coefficient           SE</span>
<span class="co">#&gt; (Intercept) 8737.2838152 3.990133e+02</span>
<span class="co">#&gt; peri           0.0410983 4.911924e-03</span></code></pre></div>
<p>To turn off standard errors (and just get point predictions), you can set <code>se = F</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/fit_fqr.html">fqr</a></span><span class="op">(</span><span class="va">area</span> <span class="op">~</span> <span class="va">peri</span>, data <span class="op">=</span> <span class="va">rock</span>, se <span class="op">=</span> <span class="cn">F</span>, tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Tau:  0.25 </span>
<span class="co">#&gt;              Coefficient SE</span>
<span class="co">#&gt; (Intercept) 5.214035e+03 NA</span>
<span class="co">#&gt; peri        4.133264e-02 NA</span>
<span class="co">#&gt; Tau:  0.5 </span>
<span class="co">#&gt;              Coefficient SE</span>
<span class="co">#&gt; (Intercept) 7.350090e+03 NA</span>
<span class="co">#&gt; peri        4.890847e-02 NA</span>
<span class="co">#&gt; Tau:  0.75 </span>
<span class="co">#&gt;              Coefficient SE</span>
<span class="co">#&gt; (Intercept) 8.739148e+03 NA</span>
<span class="co">#&gt; peri        4.057656e-02 NA</span></code></pre></div>
</div>
<div id="benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h2>
<p>Ok, but <em>how</em> fast is this approach? Let’s just take some point estimates and see how it goes.</p>
<div id="medium-n-medium-p" class="section level3">
<h3 class="hasAnchor">
<a href="#medium-n-medium-p" class="anchor"></a>Medium N, Medium P</h3>
<p>But with all of this done, let’s compare to some benchmarks from the <code>sfn</code> and <code>pfn</code> algorithms, which are currently the fastest in the <code>quantreg</code> package.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simulate some data, 101 x 100,000</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%*%</span> <span class="va">beta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="co"># let's take a look at what this looks like</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-5-1.png" width="100%"></p>
<p>Ok so we have some <em>very</em> skewed data! Perfect for median regression.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># lower level version that just takes design matrix</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_fqr.html">fit_fqr</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  15.429   0.388   3.708</span></code></pre></div>
<p>I attempted to run the same thing with the <code>quantreg</code> package, with the method advised for large datasets, like so:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># newton interior point method w/ pre-processing</span>
<span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit_pfn</span> <span class="op">&lt;-</span> <span class="fu">quantreg</span><span class="fu">::</span><span class="fu">rq.fit.pfn</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span></code></pre></div>
<p>but I killed it after 20 minutes (feel free to try this yourself!). I guess that leaves us with a comparison between ~3-5 seconds for <code>fqr</code> and a lower bound of 20 minutes for <code>pfn</code>?</p>
</div>
</div>
</div>
<div id="big-n-big-p" class="section level1">
<h1 class="hasAnchor">
<a href="#big-n-big-p" class="anchor"></a>Big N, Big P</h1>
<p>Let’s benchmark with a bigger set of columns.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e6</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">x</span> <span class="op">%*%</span> <span class="va">beta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_fqr.html">fit_fqr</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt; 152.218   3.381  24.449</span></code></pre></div>
<p>I’m not going to run the quantreg <code>pfn</code> algorithm since it was so slow for the last problem. <code>fqr</code> is a little bit slower as the columns get big, taking 25-30 seconds.</p>
<div id="big-n-small-p" class="section level3">
<h3 class="hasAnchor">
<a href="#big-n-small-p" class="anchor"></a>Big N, Small P</h3>
<p>Let’s try a more manageable set of dimensions, with <em>lots</em> of observations.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e7</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%*%</span> <span class="va">beta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_fqr.html">fit_fqr</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  93.293   2.060  20.329</span></code></pre></div>
<p>I attempted to do the comparable thing for the <code>pfn</code> algorithm:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">quantreg</span><span class="fu">::</span><span class="fu">rq.fit.pfn</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span></code></pre></div>
<p>…but I killed the process after 15 minutes or so.</p>
</div>
</div>
<div id="medium-scale-problem" class="section level1">
<h1 class="hasAnchor">
<a href="#medium-scale-problem" class="anchor"></a>Medium-scale Problem</h1>
<p>Ok, so we haven’t been able to run quantreg on these datasets, let’s see how it does with a sort of medium-scale problem. Let’s use the same DGP.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1e5</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">%*%</span> <span class="va">beta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_fqr.html">fit_fqr</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   0.869   0.070   0.230</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">fit_pfn</span> <span class="op">&lt;-</span> <span class="fu">quantreg</span><span class="fu">::</span><span class="fu">rq.fit.pfn</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, tau <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="co">#&gt; Warning in quantreg::rq.fit.pfn(x = x, y = y, tau = 0.5): Too many fixups:</span>
<span class="co">#&gt; doubling m</span>
<span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">end</span> <span class="op">-</span> <span class="va">start</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   1.574   0.383   1.790</span></code></pre></div>
<p>The coefficients match out to the 4th or 5th decimal place:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">coefficients</span> <span class="op">-</span> <span class="va">fit_pfn</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.000122037</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">coefficients</span> <span class="op">-</span> <span class="va">fit_pfn</span><span class="op">$</span><span class="va">coefficients</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 2.132279e-06</span></code></pre></div>
<div id="small-problems" class="section level3">
<h3 class="hasAnchor">
<a href="#small-problems" class="anchor"></a>Small Problems</h3>
<p>It can also be faster for small problems, and with conservative tolerance parameters will come extremely close to the default <code>quantreg</code> outputs. Here’s an example:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simulate some data, 101 x 10,000,000</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p</span>, nrow <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">x</span> <span class="op">%*%</span> <span class="va">beta</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span>
  <span class="va">fqr_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/fit_fqr.html">fqr</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, se <span class="op">=</span> <span class="cn">F</span>, beta_tol <span class="op">=</span> <span class="fl">0</span>, check_tol <span class="op">=</span> <span class="fl">0</span>,
                 data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">br_fit</span> <span class="op">&lt;-</span> <span class="fu">quantreg</span><span class="fu">::</span><span class="fu">rq</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, tau <span class="op">=</span> <span class="fl">0.5</span>, 
                    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, <span class="va">x</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"br"</span><span class="op">)</span>,
                    times <span class="op">=</span> <span class="fl">100</span>
<span class="op">)</span>
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;                                                                                          expr</span>
<span class="co">#&gt;  fqr_fit &lt;- fqr(y ~ ., se = F, beta_tol = 0, check_tol = 0, data = data.frame(y = y,      x))</span>
<span class="co">#&gt;     br_fit &lt;- quantreg::rq(y ~ ., tau = 0.5, data = data.frame(y = y,      x), method = "br")</span>
<span class="co">#&gt;       min       lq     mean  median       uq      max neval</span>
<span class="co">#&gt;  19.48368 20.30906 21.50476 20.8557 21.74249 34.92471   100</span>
<span class="co">#&gt;  75.13717 76.34309 80.20037 77.4336 82.66268 98.75256   100</span></code></pre></div>
<p>The coefficients match out to 4 decimal places:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fqr_fit</span><span class="op">$</span><span class="va">coefficients</span> <span class="op">-</span> <span class="va">br_fit</span><span class="op">$</span><span class="va">coefficients</span>
<span class="co">#&gt;               [,1]</span>
<span class="co">#&gt; [1,] -0.0009031814</span>
<span class="co">#&gt; [2,]  0.0012812620</span>
<span class="co">#&gt; [3,] -0.0004906861</span>
<span class="co">#&gt; [4,] -0.0002251114</span></code></pre></div>
<p>And the check loss is nearly identical:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">check</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">x</span>, <span class="va">tau</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">*</span> <span class="op">(</span><span class="va">tau</span> <span class="op">-</span> <span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/utils/PkgUtils.html">check</a></span><span class="op">(</span><span class="va">fqr_fit</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">-</span>  <span class="fu"><a href="https://rdrr.io/r/utils/PkgUtils.html">check</a></span><span class="op">(</span><span class="va">br_fit</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.0001522271</span></code></pre></div>
<p>Still, though, the speed gains are most noticeable once N and P are “medium” or larger (e.g. for N &lt; 300, probably just use quantreg).</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Brice Green <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://codecov.io/gh/be-green/fqr?branch=main"><img src="https://codecov.io/gh/be-green/fqr/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://github.com/be-green/fqr/actions"><img src="https://github.com/be-green/fqr/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Brice Green.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
